<div class="container" style="margin-top:100px;" id="app">
    <div v-show="showOrderInfo">
        <div id="cartPage">
            <div class="d-flex align-items-center justify-content-between">
                <h3>Кошик</h3>
                {{!-- <a href="/">Назад</a> --}}
            </div>
            <hr>
        </div>
        <div class="cart-list">
            {{#each products}}
            <div id="product-{{this.id}}" class="cart-product ply-card card">
                <a href="/product/{{this.id}}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class=" justify-content-start align-items-center">
                            <img src="{{this.mainImage}}">
                            {{this.title}}
                        </div>
                        <div style="margin:10px;">
                            <strong class="price" id="{{this.id}}">{{this.price}}₴</strong>
                            <button id="{{this.id}}" class="remove btn btn-danger btn-sm"
                                onclick="removeProdyctFromCart(event)"><i class="fa fa-trash"></i></button>
                        </div>
                    </div>
                </a>
            </div>
            {{/each}}
            <div class="d-flex justify-content-end">
                <div>
                    <div class="form-group d-flex justify-content-end">
                        Усього: <span id="sum" style="margin-left: 10px;margin-right:5px"></span> ₴
                    </div>
                    <div>

                        <button class="btn btn-primary" @click="createOrder()">Оформити замовлення</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div v-show="!showOrderInfo" class="container" style="min-height: 800px;">

        <div class="row">
            <h4>Вкажіть ваші контактні дані</h4>
        </div>



        <hr>
        <div class="row form-group">
            <label for="name" class="form-control-lable">Ваше ім'я:</label>
            <input class="form-control" id="name" v-model="name">
        </div>
        <div class="row form-group">
            <label for="tel" class="form-control-lable">Телефон:</label>
            <input class="form-control" id="tel" v-model="tel" type="tel">
        </div>
        <div class="row form-group">
            <label for="email" class="form-control-lable">Поштова скринька:</label>
            <input class="form-control" id="email" v-model="email" type="email">
        </div>
        <div class="row form-group">
            <label for="paymethod" class="form-control-lable">Спосіб оплати:</label>
            <select name="paymethod" id="paymethod" v-model="paymethod" class="form-control">
                <option value="privatbank">Приват банк</option>
                <option value="monobank">Mono банк</option>
                <option value="paypal">PayPal</option>
            </select>
        </div>
        <div class="row  form-group">
            <label for="delivery" class="form-control-lable">Спосіб доставки:</label>
            <select name="delivery" id="delivery" v-model="delivery" class="form-control">
                <option value="new_post">Нова пошта</option>
                <option value="ukrpost">Укрпошта</option>
            </select>
        </div>
        <div class="row" style="padding-top:10px; text-align:end; display:block;">
            <button class="btn btn-success" @click="sendOrder()">Відправити</button>

        </div>
        <hr>

        <div class="row" v-if="error.length!=0">
            <h6 style="color:red;">\{{error}}</h5>

        </div>
    </div>
    <div>
        <div class="row">

        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script>

    $(document).ready(() => {
        console.log("count sum");
        countSum();
    });

    var app = new Vue({
        el: '#app',
        data: {
            sum: 0,
            showOrderInfo: true,
            tel: "",
            email: "",
            name: "",
            error: "",
            paymethod: "privatbank",
            delivery: "new_post",
            productIdInCard: []

        },
        mounted() {
            if (localStorage.userName != null && localStorage.userName != "") this.name = localStorage.userName;
            if (localStorage.tel != null && localStorage.tel != "") this.tel = localStorage.tel;
            if (localStorage.email != null && localStorage.email != "") this.email = localStorage.email;
        },
        methods: {
            createOrder() {
                this.sum = Number.parseInt($('#sum').text());
                console.log(this.sum);
                this.showOrderInfo = !this.showOrderInfo;

            },
            validEmail: function (email) {
                var re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                return re.test(email);
            },
            sendOrder() {
                this.error = "";
                var validMail = this.validEmail(this.email);
                if (this.tel === "" && this.email === "") this.error = "Вкажіть телефон або електронну адресу!";
                if (!validMail && this.email.length > 0) this.error += "Вкажіть правильно емейл адресу!"
                console.log("this.error");

                console.log(this.error);
                console.log(this.tel);
                console.log(this.email);
                if (this.error == "") {
                    var ids = getCardItemIds();

                    var data = {
                        userName: this.name,
                        tel: this.tel,
                        email: this.email,
                        delivery: this.delivery,
                        paymethod: this.paymethod,
                        productIdInCard: ids

                    }
                    localStorage.userName = this.name;
                    localStorage.tel = this.tel;
                    localStorage.email = this.email;
                    console.log(data);
                    axios.post("/admin/newOrder", data).then(res => {
                        if (res.data == "ok") {
                            alert("Ваші дані успішно відправлені, ми з вами звяжемось найближчим часом!")
                            sessionStorage.clear();
                            window.location.href = "/#menu-cat"
                        } else {
                            alert("Щось пішло не так, ви можете звернутись до нас через інстаграм!");
                            window.location.href = "/#contact-us";
                        }
                    });
                }
            }
        }

    });

    function getCardItemIds() {
        var priceList = $('.price');
        var list = []
        console.log(priceList);
        priceList.each((i, e) => {
            list.push(e.id);
            console.log(e.id);
        });
        console.log(list);
        return list;
    }

    function countSum() {
        var priceList = $('.price').text();
        var sum = 0;
        var list = priceList.split("₴");
        // console.log(list);
        for (var i = 0; i < list.length; i++) {
            if (list[i].length > 0) {
                //   console.log(list[i]);
                sum += Number.parseInt(list[i]);
                $('#sum').text(sum);
            }
        }
    }

</script>